{% extends 'base.html' %}
{% load static %}

{% block title %}{{ story.title }} - CollabStory{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Story Display -->
        <div class="col-lg-8">
            <!-- Story Header -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1">{{ story.title }}</h3>
                        <div class="text-muted small">
                            <i class="bi bi-person"></i> Created by {{ story.created_by.username }} • 
                            <span class="badge bg-secondary">{{ story.get_genre_display }}</span> • 
                            <i class="bi bi-clock"></i> {{ story.created_at|timesince }} ago
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">Contributors</small><br>
                                <strong>{{ story.get_contributors.count }}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Words</small><br>
                                <strong>{{ story.word_count }}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Nodes</small><br>
                                <strong>{{ story.nodes.count }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <h6>Initial Prompt:</h6>
                    <p class="text-muted">{{ story.initial_prompt }}</p>
                </div>
            </div>

            <!-- Story Content -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-book"></i> Story Content</h5>
                    <div id="active-writers-indicator" class="text-muted small">
                        <i class="bi bi-people"></i> <span id="active-writers-count">{{ active_writers.count }}</span> active writers
                    </div>
                </div>
                <div class="card-body" id="story-content" style="max-height: 500px; overflow-y: auto;">
                    {% for node in nodes %}
                        <div class="story-node mb-3 p-3 border rounded" data-node-id="{{ node.id }}">
                            <p class="mb-2">{{ node.content }}</p>
                            <small class="text-muted">
                                — {{ node.author.username }}, {{ node.created_at|timesince }} ago
                                {% if node.ai_generated %}
                                    <span class="badge bg-info ms-1">AI-Assisted</span>
                                {% endif %}
                                <span class="ms-2">{{ node.word_count }} words</span>
                            </small>
                        </div>
                    {% empty %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-pencil-square" style="font-size: 3rem;"></i>
                            <p class="mt-3">No content yet. Start writing the story!</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Writing Area -->
            <div class="card">
                <div class="card-body">
                    <form id="add-node-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Continue the story...</label>
                            <textarea class="form-control" id="node-content" rows="4" 
                                      placeholder="What happens next?"></textarea>
                            <div class="form-text">
                                <span id="word-count">0</span> words
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Add to Story
                            </button>
                            <button type="button" class="btn btn-outline-secondary" 
                                    hx-get="{% url 'stories:get_ai_suggestion' story.id %}?type=continuation"
                                    hx-target="#ai-suggestions">
                                <i class="bi bi-robot"></i> Get AI Inspiration
                            </button>
                            <button type="button" class="btn btn-outline-info" 
                                    hx-get="{% url 'stories:get_ai_suggestion' story.id %}?type=plot_twist"
                                    hx-target="#ai-suggestions">
                                <i class="bi bi-lightning"></i> Plot Twist
                            </button>
                        </div>
                    </form>

                    <!-- AI Suggestions -->
                    <div id="ai-suggestions" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Active Writers -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6><i class="bi bi-people"></i> Active Writers</h6>
                </div>
                <div class="card-body">
                    <div id="active-writers">
                        {% for writer in active_writers %}
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-success rounded-circle me-2" style="width: 10px; height: 10px;"></div>
                                <span class="small">{{ writer.username }}</span>
                            </div>
                        {% empty %}
                            <p class="text-muted small">No active writers</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- AI Assistance Panel -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6><i class="bi bi-robot"></i> AI Writing Assistant</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-info btn-sm"
                                hx-get="{% url 'stories:get_ai_suggestion' story.id %}?type=character"
                                hx-target="#ai-suggestions">
                            <i class="bi bi-person"></i> Character Idea
                        </button>
                        <button class="btn btn-outline-info btn-sm"
                                hx-get="{% url 'stories:get_ai_suggestion' story.id %}?type=dialogue"
                                hx-target="#ai-suggestions">
                            <i class="bi bi-chat"></i> Dialogue
                        </button>
                        <button class="btn btn-outline-info btn-sm"
                                hx-get="{% url 'stories:get_ai_suggestion' story.id %}?type=setting"
                                hx-target="#ai-suggestions">
                            <i class="bi bi-geo-alt"></i> Setting
                        </button>
                        <button class="btn btn-outline-info btn-sm"
                                hx-get="{% url 'stories:get_ai_suggestion' story.id %}?type=conflict"
                                hx-target="#ai-suggestions">
                            <i class="bi bi-exclamation-triangle"></i> Conflict
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent AI Prompts -->
            {% if recent_prompts %}
                <div class="card mb-3">
                    <div class="card-header">
                        <h6><i class="bi bi-lightbulb"></i> Recent Suggestions</h6>
                    </div>
                    <div class="card-body">
                        {% for prompt in recent_prompts %}
                            <div class="border rounded p-2 mb-2">
                                <small class="text-muted">{{ prompt.get_prompt_type_display }}</small>
                                <p class="small mb-1">{{ prompt.generated_text|truncatewords:15 }}</p>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="useAISuggestion('{{ prompt.id }}', '{{ prompt.generated_text|escapejs }}')">
                                    Use This
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Comments -->
            <div class="card">
                <div class="card-header">
                    <h6><i class="bi bi-chat"></i> Comments</h6>
                </div>
                <div class="card-body">
                    <div id="comments-list">
                        {% for comment in comments %}
                            <div class="border-bottom pb-2 mb-2">
                                <div class="d-flex justify-content-between">
                                    <strong class="small">{{ comment.user.username }}</strong>
                                    <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                                </div>
                                <p class="small mb-0">{{ comment.content }}</p>
                            </div>
                        {% empty %}
                            <p class="text-muted small">No comments yet</p>
                        {% endfor %}
                    </div>
                    
                    <form id="comment-form" class="mt-3">
                        {% csrf_token %}
                        <div class="mb-2">
                            <textarea class="form-control form-control-sm" name="content" 
                                      placeholder="Add a comment..." rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-primary">Post Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const storyId = {{ story.id }};
const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
const wsPath = `${wsScheme}://${window.location.host}/ws/story/${storyId}/`;
const storySocket = new WebSocket(wsPath);

// WebSocket event handlers
storySocket.onopen = function(e) {
    console.log('Connected to story WebSocket');
};

storySocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    
    if (data.type === 'new_node') {
        addNewNode(data);
    } else if (data.type === 'user_activity') {
        showNotification(data.message);
        updateActiveWriters();
    } else if (data.type === 'typing') {
        updateTypingIndicator(data.user, data.is_typing);
    } else if (data.type === 'comment') {
        addNewComment(data);
    }
};

storySocket.onclose = function(e) {
    console.log('Disconnected from story WebSocket');
};

storySocket.onerror = function(e) {
    console.error('WebSocket error:', e);
};

// Add new node to story display
function addNewNode(data) {
    const storyContent = document.getElementById('story-content');
    const newNode = document.createElement('div');
    newNode.className = 'story-node mb-3 p-3 border rounded';
    newNode.setAttribute('data-node-id', data.node_id);
    newNode.innerHTML = `
        <p class="mb-2">${data.node_content}</p>
        <small class="text-muted">
            — ${data.author}, just now
            <span class="ms-2">${data.word_count} words</span>
        </small>
    `;
    storyContent.appendChild(newNode);
    
    // Clear the textarea
    document.getElementById('node-content').value = '';
    updateWordCount();
    
    // Scroll to bottom
    storyContent.scrollTop = storyContent.scrollHeight;
}

// Add new comment
function addNewComment(data) {
    const commentsList = document.getElementById('comments-list');
    const newComment = document.createElement('div');
    newComment.className = 'border-bottom pb-2 mb-2';
    newComment.innerHTML = `
        <div class="d-flex justify-content-between">
            <strong class="small">${data.author}</strong>
            <small class="text-muted">just now</small>
        </div>
        <p class="small mb-0">${data.comment}</p>
    `;
    commentsList.appendChild(newComment);
}

// Handle form submission
document.getElementById('add-node-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('node-content').value.trim();
    
    if (!content) return;
    
    fetch(`/stories/${storyId}/add_node/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            content: content,
            parent_node_id: null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Node added successfully');
        } else {
            console.error('Error adding node:', data.error);
        }
    });
});

// Handle comment form submission
document.getElementById('comment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch(`/stories/${storyId}/comment/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            this.reset();
        }
    });
});

// Typing indicators
let typingTimer;
document.getElementById('node-content').addEventListener('input', function() {
    // Send typing start
    storySocket.send(JSON.stringify({
        type: 'user_typing',
        user: '{{ request.user.username }}',
        is_typing: true
    }));
    
    // Clear previous timer
    clearTimeout(typingTimer);
    
    // Set timer to send typing stop after 1 second of inactivity
    typingTimer = setTimeout(() => {
        storySocket.send(JSON.stringify({
            type: 'user_typing',
            user: '{{ request.user.username }}',
            is_typing: false
        }));
    }, 1000);
    
    updateWordCount();
});

// Update word count
function updateWordCount() {
    const content = document.getElementById('node-content').value;
    const wordCount = content.trim().split(/\s+/).filter(word => word.length > 0).length;
    document.getElementById('word-count').textContent = wordCount;
}

// Use AI suggestion
function useAISuggestion(promptId, suggestion) {
    document.getElementById('node-content').value = suggestion;
    updateWordCount();
    
    // Mark as used
    fetch(`/stories/ai_suggestion/${promptId}/use/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    });
}

// Show notification
function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
}

// Update active writers count
function updateActiveWriters() {
    // This would typically be updated via WebSocket
    // For now, we'll just refresh the count
    fetch(`/stories/${storyId}/`)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const activeWritersCount = doc.querySelector('#active-writers-count');
            if (activeWritersCount) {
                document.getElementById('active-writers-count').textContent = activeWritersCount.textContent;
            }
        });
}

// Initialize word count
updateWordCount();
</script>
{% endblock %}
